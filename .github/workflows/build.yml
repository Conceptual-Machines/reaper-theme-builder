name: Build Theme

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Download base theme (if not present)
        env:
          THEME_SOURCE_URL: ${{ secrets.THEME_SOURCE_URL }}
        run: |
          mkdir -p theme_source
          
          if [ -f "theme_source/LCS_Flat-7.ReaperThemeZip" ]; then
            echo "Base theme already present"
            exit 0
          fi
          
          # Option 1: Download from secret URL
          if [ -n "$THEME_SOURCE_URL" ]; then
            echo "Downloading base theme from secret URL..."
            curl -L "$THEME_SOURCE_URL" -o theme_source/LCS_Flat-7.ReaperThemeZip
            exit 0
          fi
          
          # Option 2: Download from REAPER stash (if available)
          # LCS Flat 7 is available on REAPER Stash: https://stash.reaper.fm/theme/2925/LCS%20Flat%207.ReaperThemeZip
          echo "Attempting to download from REAPER Stash..."
          curl -fL "https://stash.reaper.fm/38076/LCS%20Flat%207.ReaperThemeZip" -o theme_source/LCS_Flat-7.ReaperThemeZip || {
            echo "ERROR: Could not download base theme"
            echo "Please set THEME_SOURCE_URL secret or commit the theme file"
            exit 1
          }
      
      - name: Extract base theme
        run: |
          cd theme_source
          if [ ! -d "LCS_Flat7_unpacked" ]; then
            unzip -o LCS_Flat-7.ReaperThemeZip -d LCS_Flat7_unpacked
          fi
      
      - name: Setup build directory
        run: |
          mkdir -p build
          if [ ! -d "build/DarkMinimal_unpacked" ]; then
            cp -r theme_source/LCS_Flat7_unpacked/LCS_Flat-707_unpacked build/DarkMinimal_unpacked
            cp theme_source/LCS_Flat7_unpacked/LCS_Flat-707_unpacked.ReaperTheme build/DarkMinimal_unpacked.ReaperTheme
          fi
      
      - name: Build theme
        run: python scripts/build_all.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DarkMinimal-Theme
          path: DarkMinimal.ReaperThemeZip
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: DarkMinimal.ReaperThemeZip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

